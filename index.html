document.addEventListener('DOMContentLoaded', () => {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const captureBtn = document.getElementById('captureBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const retakeBtn = document.getElementById('retakeBtn');
    const photo = document.getElementById('photo');
    const resultSection = document.getElementById('resultSection');
    const placeholder = document.getElementById('placeholder');
    const filterBtns = document.querySelectorAll('.filter-btn');
    const cameraSwitcher = document.getElementById('cameraSwitcher');

    let stream = null;
    let currentFilter = 'none';

    // 利用可能なカメラデバイスを取得してセレクトボックスに表示
    const getCameraDevices = async () => {
        try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            
            cameraSwitcher.innerHTML = ''; // 既存のオプションをクリア

            if (videoDevices.length > 1) {
                videoDevices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    // ラベルがなければ「カメラ N」と表示
                    option.text = device.label || `Camera ${cameraSwitcher.length + 1}`;
                    cameraSwitcher.appendChild(option);
                });
                cameraSwitcher.disabled = false;
            } else {
                cameraSwitcher.disabled = true;
            }
        } catch (err) {
            console.error('デバイスの列挙に失敗しました:', err);
        }
    };

    // カメラを起動する関数
    const startCamera = async (deviceId = null) => {
        try {
            // 既存のストリームがあれば停止
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: 'user' }
            };
            
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            video.style.display = 'block';
            placeholder.style.display = 'none';
            startBtn.textContent = 'カメラを停止';
            startBtn.onclick = stopCamera;
            captureBtn.disabled = false;

            // カメラデバイスリストを更新
            await getCameraDevices();
            // 現在のカメラをセレクトボックスで選択状態にする
            if (stream) {
                const currentDevice = stream.getVideoTracks()[0];
                if (currentDevice) {
                    cameraSwitcher.value = currentDevice.getSettings().deviceId;
                }
            }

        } catch (err) {
            console.error('カメラへのアクセスに失敗しました:', err);
            placeholder.innerHTML = '<p style="color: red;">カメラへのアクセスを許可するか、カメラが接続されているか確認してください。</p>';
        }
    };

    // カメラを停止する関数
    const stopCamera = () => {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
            stream = null;
        }
        video.style.display = 'none';
        placeholder.style.display = 'flex';
        startBtn.textContent = 'カメラを起動';
        startBtn.onclick = () => startCamera();
        captureBtn.disabled = true;
        cameraSwitcher.disabled = true;
    };

    // フィルターを適用する関数
    const applyFilter = (filterValue) => {
        currentFilter = filterValue;
        video.style.filter = currentFilter;
        
        // アクティブなボタンのスタイルを更新
        filterBtns.forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.filter === filterValue) {
                btn.classList.add('active');
            }
        });
    };

    // 写真を撮影する関数
    const capturePhoto = () => {
        // Canvasのサイズをビデオに合わせる
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // ★重要: Canvasのコンテキストに現在のフィルターを適用する
        // これにより、video要素の見た目だけでなく、
        // 描画される画像データ自体にフィルターが反映されます。
        context.filter = currentFilter;

        // フィルターが適用された状態で、videoをcanvasに描画
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Canvasから画像データを取得 (PNG形式)
        const imageDataUrl = canvas.toDataURL('image/png');
        photo.src = imageDataUrl;
        downloadBtn.href = imageDataUrl;

        // タイムスタンプ付きのファイル名を生成
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        downloadBtn.download = `photo_${timestamp}.png`;

        // 結果を表示
        resultSection.style.display = 'block';
        captureBtn.disabled = true;
    };

    // 撮り直す関数
    const retakePhoto = () => {
        resultSection.style.display = 'none';
        photo.src = '';
        captureBtn.disabled = false;
    };

    // イベントリスナーの設定
    startBtn.addEventListener('click', () => startCamera());
    captureBtn.addEventListener('click', capturePhoto);
    retakeBtn.addEventListener('click', retakePhoto);

    // カメラ切り替えイベント
    cameraSwitcher.addEventListener('change', (event) => {
        const selectedDeviceId = event.target.value;
        if (selectedDeviceId) {
            startCamera(selectedDeviceId);
        }
    });

    filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            applyFilter(btn.dataset.filter);
        });
    });
});
